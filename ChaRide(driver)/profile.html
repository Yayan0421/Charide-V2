<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Charide | Profile</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

	<style>
		*{
			margin:0;
			padding:0;
			box-sizing:border-box;
			font-family:'Inter', sans-serif;
		}

		body{
			background:#f4f4f4;
			color:#1f2937;
		}

		.app{
			display:flex;
			min-height:100vh;
			margin-left:280px;
		}

		.sidebar{
			position:fixed;
		top:0;
		left:0;
		height:100vh;
			background:linear-gradient(180deg, #0aa812 0%, #078c0f 100%);
			color:#fff;
			display:flex;
			flex-direction:column;
			padding:0;
			box-shadow:4px 0 12px rgba(10, 168, 18, 0.2);
			overflow-y:auto;
			transition:width 0.3s ease;
		}

		.sidebar-header{
			padding:30px 20px;
			display:flex;
			align-items:center;
			gap:12px;
			border-bottom:2px solid rgba(255, 255, 255, 0.1);
		}

		.sidebar-logo{
			width:48px;
			height:48px;
			object-fit:contain;
			border-radius:50%;
			background:white;
			padding:4px;
		}

		.sidebar-title{
			font-size:24px;
			font-weight:700;
			color:#ffffff;
			white-space:nowrap;
		}

		.sidebar-toggle{
			margin-left:auto;
			background:rgba(255, 255, 255, 0.18);
			border:none;
			color:#fff;
			width:36px;
			height:36px;
			border-radius:10px;
			cursor:pointer;
			font-size:18px;
			display:flex;
			align-items:center;
			justify-content:center;
			transition:transform 0.3s ease, background 0.3s ease;
		}

		.sidebar-links{
			flex:1;
			padding:20px 0;
			display:flex;
			flex-direction:column;
		}

		.sidebar-links a{
			display:flex;
			align-items:center;
			gap:12px;
			padding:15px 20px;
			color:rgba(255, 255, 255, 0.9);
			text-decoration:none;
			transition:all 0.3s ease;
			cursor:pointer;
			font-size:15px;
			font-weight:500;
			border-left:4px solid transparent;
		}

		.sidebar-links a .link-text{
			flex:1;
		}

		.sidebar-links a:hover,
		.sidebar-links a.active{
			background:rgba(255, 255, 255, 0.1);
			color:#ffffff;
			border-left-color:#ffc107;
		}

		.sidebar-profile{
			display:flex;
			align-items:center;
			gap:10px;
			padding:20px;
			border-bottom:2px solid rgba(255, 255, 255, 0.1);
		}

		.avatar{
			width:56px;
			height:56px;
			background:rgba(255, 255, 255, 0.2);
			border-radius:50%;
			display:flex;
			align-items:center;
			justify-content:center;
			font-weight:bold;
			color:#fff;
			flex-shrink:0;
			font-size:16px;
		}

		.profile-info{
			display:flex;
			flex-direction:column;
		}

		.profile-info strong{
			font-size:14px;
			color:#ffffff;
			margin:0;
			font-weight:600;
		}

		.profile-info small{
			font-size:12px;
			color:rgba(255, 255, 255, 0.8);
			margin:2px 0 0 0;
		}

		.sidebar-logout{
			display:flex;
			align-items:center;
			gap:12px;
			padding:15px 20px;
			color:rgba(255, 255, 255, 0.9);
			text-decoration:none;
			transition:all 0.3s ease;
			cursor:pointer;
			font-size:15px;
			font-weight:500;
			border-left:4px solid transparent;
			border-top:2px solid rgba(255, 255, 255, 0.1);
			margin-top:auto;
		}

		.sidebar-logout:hover{
			background:rgba(255, 255, 255, 0.1);
			color:#ffffff;
			border-left-color:#ff6b6b;
		}

		.app.is-collapsed .sidebar{
			width:90px;
		}

		.app.is-collapsed .sidebar-title,
		.app.is-collapsed .profile-info,
		.app.is-collapsed .sidebar-links a .link-text{
			display:none;
		}

		.app.is-collapsed .sidebar-header{
			justify-content:center;
		}

		.app.is-collapsed .sidebar-toggle{
			transform:rotate(180deg);
		}

		/* MAIN */
		.content{
			flex:1;
			padding:24px 28px;
		}

		.page-header{
			display:flex;
			align-items:flex-start;
			justify-content:space-between;
			gap:16px;
			margin-bottom:18px;
		}

		.page-header h1{
			font-size:22px;
			margin-bottom:4px;
			color:#111827;
		}

		.page-header p{
			color:#6b7280;
			font-size:13px;
		}

		.edit-btn{
			display:inline-flex;
			align-items:center;
			gap:8px;
			border:1px solid #e5e7eb;
			background:#ffffff;
			padding:8px 14px;
			border-radius:10px;
			font-weight:600;
			cursor:pointer;
		}

		.profile-card{
			background:#0aa812;
			border:1px solid #0aa812;
			border-radius:16px;
			overflow:hidden;
			box-shadow:0 2px 8px rgba(0,0,0,0.06);
			margin-bottom:18px;
		}

		.profile-banner{
			background:linear-gradient(90deg, #0aa812 0%, #1dbb5a 100%);
			height:80px;
		}

		.profile-body{
			display:flex;
			align-items:center;
			gap:18px;
			padding:18px 20px 20px;
			position:relative;
		}

		.profile-photo{
			width:90px;
			height:90px;
			border-radius:50%;
			background:#ffffff;
			border:4px solid #ffffff;
			box-shadow:0 4px 12px rgba(0,0,0,0.12);
			display:flex;
			align-items:center;
			justify-content:center;
			font-weight:700;
			color:#9ca3af;
			margin-top:-60px;
			position:relative;
		}

		.profile-photo span{
			font-size:26px;
		}

		.photo-badge{
			position:absolute;
			right:-4px;
			bottom:-4px;
			width:30px;
			height:30px;
			border-radius:50%;
			background:#0aa812;
			color:#fff;
			display:flex;
			align-items:center;
			justify-content:center;
			font-size:14px;
			border:3px solid #ffffff;
		}

		.profile-meta h2{
			font-size:20px;
			margin-bottom:4px;
			color:#ffffff;
		}

		.profile-meta p{
			color:rgba(255, 255, 255, 0.9);
			font-size:13px;
			margin-bottom:8px;
		}

		.badges{
			display:flex;
			align-items:center;
			gap:10px;
			flex-wrap:wrap;
		}

		.badge{
			background:#fef3c7;
			color:#b45309;
			border-radius:999px;
			padding:4px 10px;
			font-size:12px;
			font-weight:600;
			display:inline-flex;
			align-items:center;
			gap:6px;
		}

		.badge-approved{
			background:#dcfce7;
			color:#166534;
		}

		.rating{
			display:inline-flex;
			align-items:center;
			gap:6px;
			font-weight:700;
		}

		.info-grid{
			display:grid;
			grid-template-columns:1fr 1fr;
			gap:16px;
			margin-bottom:18px;
		}

		.info-card{
			background:#ffffff;
			border:1px solid #e5e7eb;
			border-radius:14px;
			padding:18px;
			box-shadow:0 2px 8px rgba(0,0,0,0.06);
		}

		.info-card h3{
			font-size:15px;
			margin-bottom:12px;
			display:flex;
			align-items:center;
			gap:8px;
		}

		.info-item{
			margin-bottom:12px;
			font-size:13px;
			color:#6b7280;
		}

		.info-item strong{
			display:block;
			color:#111827;
			margin-top:4px;
			font-size:14px;
		}

		.stats-card{
			background:#ffffff;
			border:1px solid #e5e7eb;
			border-radius:14px;
			padding:18px;
			box-shadow:0 2px 8px rgba(0,0,0,0.06);
		}

		.stats-card h3{
			font-size:15px;
			margin-bottom:14px;
		}

		.stats-grid{
			display:grid;
			grid-template-columns:repeat(4, minmax(0, 1fr));
			gap:12px;
		}

		.stat{
			border-radius:12px;
			padding:16px 14px;
			text-align:center;
			font-weight:700;
			color:#111827;
			background:#f9fafb;
		}

		.stat small{
			display:block;
			font-size:12px;
			color:#6b7280;
			margin-bottom:6px;
			font-weight:600;
		}

		/* DASHBOARD STATS CARDS */
		.stats{
			display:grid;
			grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
			gap:15px;
			margin-bottom:25px;
		}

		.stats .card{
			background:#fff;
			padding:15px;
			border-radius:12px;
			box-shadow:0 2px 8px rgba(0,0,0,0.15);
		}

		.card-header{
			display:flex;
			justify-content:space-between;
			font-weight:bold;
			margin-bottom:8px;
		}

		.badge-live{
			background:#43a047;
			color:#fff;
			font-size:10px;
			padding:2px 6px;
			border-radius:4px;
		}

		.stats .card h2{
			font-size:24px;
			margin:8px 0;
			color:#111827;
		}

		.stats .card p{
			font-size:13px;
			color:#6b7280;
			margin:0;
		}

		@media (max-width: 1100px){
			.info-grid{
				grid-template-columns:1fr;
			}

			.stats-grid{
				grid-template-columns:repeat(2, minmax(0, 1fr));
			}
		}

		@media (max-width: 820px){
			.sidebar{
				width:90px;
			}

			.sidebar-title,
			.profile-info,
			.sidebar-links a .link-text{
				display:none;
			}

			.sidebar-header{
				justify-content:center;
			}
		}

	/* MODAL */
	.modal{
		display:none;
		position:fixed;
		top:0;
		left:0;
		width:100%;
		height:100%;
		background:rgba(0, 0, 0, 0.6);
		z-index:1000;
		align-items:center;
		justify-content:center;
	}

	.modal.active{
		display:flex;
	}

	.modal-content{
		background:#fff;
		border-radius:16px;
		max-width:600px;
		width:90%;
		max-height:90vh;
		overflow-y:auto;
		box-shadow:0 8px 32px rgba(0,0,0,0.2);
	}

	.modal-header{
		padding:20px 24px;
		border-bottom:1px solid #e5e7eb;
		display:flex;
		align-items:center;
		justify-content:space-between;
	}

	.modal-header h2{
		font-size:20px;
		margin:0;
	}

	.modal-close{
		background:none;
		border:none;
		font-size:24px;
		cursor:pointer;
		color:#6b7280;
		width:32px;
		height:32px;
		display:flex;
		align-items:center;
		justify-content:center;
		border-radius:8px;
		transition:background 0.2s;
	}

	.modal-close:hover{
		background:#f3f4f6;
	}

	.modal-body{
		padding:24px;
	}

	.form-group{
		margin-bottom:18px;
	}

	.form-group label{
		display:block;
		margin-bottom:8px;
		font-weight:600;
		font-size:14px;
		color:#374151;
	}

	.form-group input,
	.form-group select{
		width:100%;
		padding:10px 12px;
		border:1px solid #d1d5db;
		border-radius:8px;
		font-size:14px;
		font-family:'Inter', sans-serif;
		transition:border-color 0.2s;
	}

	.form-group input:focus,
	.form-group select:focus{
		outline:none;
		border-color:#0aa812;
	}

	.file-upload{
		display:flex;
		align-items:center;
		gap:12px;
	}

	.file-upload input[type="file"]{
		display:none;
	}

	.file-upload-btn{
		padding:10px 16px;
		background:#f3f4f6;
		border:1px solid #d1d5db;
		border-radius:8px;
		font-size:14px;
		font-weight:600;
		cursor:pointer;
		transition:background 0.2s;
	}

	.file-upload-btn:hover{
		background:#e5e7eb;
	}

	.file-name{
		font-size:13px;
		color:#6b7280;
	}

	.modal-footer{
		padding:16px 24px;
		border-top:1px solid #e5e7eb;
		display:flex;
		gap:12px;
		justify-content:flex-end;
	}

	.btn{
		padding:10px 20px;
		border-radius:8px;
		font-size:14px;
		font-weight:600;
		cursor:pointer;
		transition:all 0.2s;
		border:none;
	}

	.btn-cancel{
		background:#f3f4f6;
		color:#374151;
	}

	.btn-cancel:hover{
		background:#e5e7eb;
	}

	.btn-save{
		background:#0aa812;
		color:#fff;
	}

	.btn-save:hover{
		background:#078c0f;
	}

	.btn-save:disabled{
		background:#9ca3af;
		cursor:not-allowed;
	}
</style>
</head>

<body>
	<div class="app" id="appShell">
		<aside class="sidebar">
			<div class="sidebar-header">
				<img src="logo.png" alt="Charide" class="sidebar-logo">
				<span class="sidebar-title">Charide</span>
				<button class="sidebar-toggle" id="sidebarCollapse" aria-label="Collapse sidebar">‚Äπ</button>
			</div>

			<nav class="sidebar-links">
				<a href="dashboard-driver.html">üè† <span class="link-text">Dashboard</span></a>
				<a href="message-1.html">üí¨ <span class="link-text">Messages</span></a>
				<a href="booking.html">üóìÔ∏è <span class="link-text">Bookings</span></a>
				<a href="support-devices.html">üÜò <span class="link-text">Support</span></a>
				<a href="about-us-1.html">‚ÑπÔ∏è <span class="link-text">About Us</span></a>
				<a href="profile.html" class="active">üë§ <span class="link-text">Profile</span></a>
			</nav>

			<div class="sidebar-profile">
				<div class="avatar" id="sidebarAvatar">KR</div>
				<div class="profile-info">
					<strong id="sidebarName">Kim Ryan</strong>
					<small>Driver</small>
				</div>
			</div>

			<a href="#" class="sidebar-logout" onclick="logout(); return false;">üö™ Log Out</a>
		</aside>

		<main class="content">
			<div class="page-header">
				<div>
					<h1>My Profile</h1>
					<p>Manage your driver profile and settings</p>
				</div>
				<button class="edit-btn" id="openEditModal">‚úèÔ∏è Edit Profile</button>
			</div>

			<section class="profile-card">
				<div class="profile-banner"></div>
				<div class="profile-body">
					<div class="profile-photo">
						<img id="profileImage" src="" alt="Profile" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;">
						<span id="profileFallback">üë§</span>
						<div class="photo-badge">üì∑</div>
					</div>
					<div class="profile-meta">
						<h2 id="profileName">Palalon Kim Ryan Delmonte</h2>
						<p id="profileEmail">kim.ryan.delmonte.palalon@gmail.com</p>
						<div class="badges">
							<div class="badge" id="verificationBadge">‚è≥ Pending Verification</div>
							<div class="rating">‚≠ê 5.0</div>
						</div>
					</div>
				</div>
			</section>

			<section class="info-grid">
				<div class="info-card">
					<h3>üë§ Personal Information</h3>
					<div class="info-item">
						Full Name
						<strong id="infoFullName">Palalon Kim Ryan Delmonte</strong>
					</div>
					<div class="info-item">
						Phone Number
						<strong id="infoPhone">09518279905</strong>
					</div>
					<div class="info-item">
						Email
						<strong id="infoEmail">kim.ryan.delmonte.palalon@gmail.com</strong>
					</div>
					<div class="info-item">
						Username
						<strong id="infoUsername">-</strong>
					</div>
				</div>

				<div class="info-card">
					<h3>üöó Vehicle Information</h3>
					<div class="info-item">
						Vehicle Type
						<strong id="infoVehicle">Tricycle</strong>
					</div>
					<div class="info-item">
						Plate Number
						<strong id="infoPlate">abs-123</strong>
					</div>
					<div class="info-item">
						License Number
						<strong id="infoLicense">dihwhwhwiew</strong>
					</div>
				</div>
			</section>

			<section class="stats-card">
				<h3>Driver Statistics</h3>
				<div class="stats-grid">
					<div class="stat" style="background:#ecfdf3; color:#047857;">
						<small>Total Trips</small>
						0
					</div>
					<div class="stat" style="background:#fffbeb; color:#b45309;">
						<small>Rating</small>
						5.0
					</div>
					<div class="stat" style="background:#eff6ff; color:#1d4ed8;">
						<small>Status</small>
						Available
					</div>
					<div class="stat" style="background:#f5f3ff; color:#7c3aed;">
						<small>Reports</small>
						No
					</div>
				</div>
			</section>

			<div class="stats">
				<div class="card">
					<div class="card-header"><span>Today's Earnings</span><span class="badge-live">Live</span></div>
					<h2 id="earningsAmount">‚Ç±0</h2>
					<p id="earningsChange">+0% from yesterday</p>
				</div>

				<div class="card">
					<div class="card-header"><span>My Route</span><span class="badge-live">Live</span></div>
					<h2 id="distanceStat">0 km</h2>
					<p id="routeDescription">-</p>
				</div>

				<div class="card">
					<div class="card-header"><span>Today's Bookings</span><span class="badge-live">Live</span></div>
					<h2 id="bookingsCount">0</h2>
					<p id="bookingsStatus">-</p>
				</div>

				<div class="card">
					<div class="card-header"><span>Weekly Average</span><span class="badge-live">Live</span></div>
					<h2 id="weeklyAverage">‚Ç±0</h2>
					<p id="weeklyChange">+0% from last week</p>
				</div>
			</div>
		</main>
	</div>

	<!-- Edit Profile Modal -->
	<div class="modal" id="editModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Edit Profile</h2>
				<button class="modal-close" id="closeModal">√ó</button>
			</div>
			<div class="modal-body">
				<form id="editProfileForm">
					<div class="form-group">
						<label>Profile Picture</label>
						<div class="file-upload">
							<label for="profilePicInput" class="file-upload-btn">Choose File</label>
							<input type="file" id="profilePicInput" accept="image/*">
							<span class="file-name" id="fileName">No file chosen</span>
						</div>
					</div>

					<div class="form-group">
						<label for="editFirstName">First Name</label>
						<input type="text" id="editFirstName" required>
					</div>

					<div class="form-group">
						<label for="editLastName">Last Name</label>
						<input type="text" id="editLastName" required>
					</div>

					<div class="form-group">
						<label for="editUsername">Username</label>
						<input type="text" id="editUsername" required>
					</div>

					<div class="form-group">
						<label for="editEmail">Email</label>
						<input type="email" id="editEmail" required>
					</div>

					<div class="form-group">
						<label for="editMobile">Phone Number</label>
						<input type="tel" id="editMobile" required>
					</div>

					<div class="form-group">
						<label for="editVehicleType">Vehicle Type</label>
						<select id="editVehicleType" required>
							<option value="">Select vehicle type</option>
							<option value="Tricycle">Tricycle</option>
							<option value="Motorcycle">Motorcycle</option>
							<option value="Car">Car</option>
							<option value="Van">Van</option>
						</select>
					</div>

					<div class="form-group">
						<label for="editPlateNumber">Plate Number</label>
						<input type="text" id="editPlateNumber" required>
					</div>

					<div class="form-group">
						<label for="editLicenseId">License Number</label>
						<input type="text" id="editLicenseId" required>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
				<button type="submit" form="editProfileForm" class="btn btn-save" id="saveBtn">Save Changes</button>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		const { createClient } = supabase;
		const supabaseUrl = 'https://cvfjpigbkbzjvvfzvjzr.supabase.co';
		const supabaseKey = 'sb_publishable_Wt2fAK6-5mkAX4SNyobCYQ_YPROnFM4';
		const supabaseClient = createClient(supabaseUrl, supabaseKey, {
			global: {
				headers: {
					apikey: supabaseKey,
					Authorization: `Bearer ${supabaseKey}`
				}
			}
		});

		const appShell = document.getElementById('appShell');
		const sidebarCollapse = document.getElementById('sidebarCollapse');

		sidebarCollapse.addEventListener('click', () => {
			appShell.classList.toggle('is-collapsed');
		});

		function setText(id, value, fallback = '-') {
			const el = document.getElementById(id);
			if (el) {
				el.textContent = value || fallback;
			}
		}

		function getInitials(name) {
			if (!name) return 'DR';
			return name.split(' ').map(part => part[0]).join('').toUpperCase().slice(0, 2);
		}

		function setVerificationStatus(statusValue) {
			const badge = document.getElementById('verificationBadge');
			if (!badge) return;
			const normalized = String(statusValue || '').trim().toLowerCase();
			const isApproved = normalized === 'approved' || normalized === 'approve' || normalized === 'verified';
			badge.classList.toggle('badge-approved', isApproved);
			badge.textContent = isApproved ? '‚úÖ Approved' : '‚è≥ Pending Verification';
		}

		// Edit Profile Functionality
		let currentDriverData = null;

		const editModal = document.getElementById('editModal');
		const openEditModalBtn = document.getElementById('openEditModal');
		const closeModalBtn = document.getElementById('closeModal');
		const cancelBtn = document.getElementById('cancelBtn');
		const editProfileForm = document.getElementById('editProfileForm');
		const saveBtn = document.getElementById('saveBtn');
		const profilePicInput = document.getElementById('profilePicInput');
		const fileNameSpan = document.getElementById('fileName');

		// Open modal
		openEditModalBtn.addEventListener('click', () => {
			if (currentDriverData) {
				populateEditForm(currentDriverData);
				editModal.classList.add('active');
			}
		});

		// Close modal
		function closeEditModal() {
			editModal.classList.remove('active');
			editProfileForm.reset();
			fileNameSpan.textContent = 'No file chosen';
		}

		closeModalBtn.addEventListener('click', closeEditModal);
		cancelBtn.addEventListener('click', closeEditModal);

		// Close modal on outside click
		editModal.addEventListener('click', (e) => {
			if (e.target === editModal) {
				closeEditModal();
			}
		});

		// Handle file selection
		profilePicInput.addEventListener('change', (e) => {
			const file = e.target.files[0];
			if (file) {
				fileNameSpan.textContent = file.name;
			} else {
				fileNameSpan.textContent = 'No file chosen';
			}
		});

		// Populate form with current data
		function populateEditForm(data) {
			document.getElementById('editFirstName').value = data.first_name || '';
			document.getElementById('editLastName').value = data.last_name || '';
			document.getElementById('editUsername').value = data.username || '';
			document.getElementById('editEmail').value = data.email || '';
			document.getElementById('editMobile').value = data.mobile || '';
			document.getElementById('editVehicleType').value = data.vehicle_type || '';
			document.getElementById('editPlateNumber').value = data.plate_number || '';
			document.getElementById('editLicenseId').value = data.license_id || '';
		}

		// Save profile changes
		editProfileForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			if (!currentDriverData) {
				alert('No profile data loaded');
				return;
			}

			saveBtn.disabled = true;
			saveBtn.textContent = 'Saving...';

			try {
				let profilePicPath = currentDriverData.profile_pic_path;

				// Upload profile picture if selected
				const file = profilePicInput.files[0];
				if (file) {
					const fileExt = file.name.split('.').pop();
					const fileName = `profile/${new Date().toISOString().replace(/:/g, '-')}_${Math.floor(Math.random() * 1000)}.${fileExt}`;
					
					const { data: uploadData, error: uploadError } = await supabaseClient.storage
						.from('driver_info')
						.upload(fileName, file, {
							cacheControl: '3600',
							upsert: false
						});

					if (uploadError) {
						console.error('Upload error:', uploadError);
						alert('Failed to upload profile picture: ' + uploadError.message);
						saveBtn.disabled = false;
						saveBtn.textContent = 'Save Changes';
						return;
					}

					profilePicPath = fileName;
					console.log('Profile picture uploaded:', fileName);
				}

				// Update driver info in database
				const updatedData = {
					first_name: document.getElementById('editFirstName').value,
					last_name: document.getElementById('editLastName').value,
					username: document.getElementById('editUsername').value,
					email: document.getElementById('editEmail').value,
					mobile: document.getElementById('editMobile').value,
					vehicle_type: document.getElementById('editVehicleType').value,
					plate_number: document.getElementById('editPlateNumber').value,
					license_id: document.getElementById('editLicenseId').value,
					profile_pic_path: profilePicPath
				};

				console.log('Attempting to update with data:', updatedData);

				const { error: updateError } = await supabaseClient
					.from('drivers')
					.update(updatedData)
					.eq('user_id', currentDriverData.user_id || currentDriverData.id);

				if (updateError) {
					console.error('Update error:', updateError);
					alert('Failed to update profile: ' + updateError.message);
					saveBtn.disabled = false;
					saveBtn.textContent = 'Save Changes';
					return;
				}

				console.log('Profile updated successfully');
				alert('Profile updated successfully!');
				closeEditModal();
				
				// Reload profile to show updated data
				await loadProfile();

			} catch (error) {
				console.error('Error saving profile:', error);
				alert('An error occurred while saving your profile');
			} finally {
				saveBtn.disabled = false;
				saveBtn.textContent = 'Save Changes';
			}
		});

		async function loadProfile() {
			// Get current logged-in user
			const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
			
			if (authError || !user) {
				console.error('Not authenticated');
				return;
			}

			// Load profile - try matching by user_id first, if that fails, get the most recent
			let data, error;
			
			// First try to get by user_id
			const { data: userIdData, error: userIdError } = await supabaseClient
				.from('drivers')
				.select('*')
				.eq('user_id', user.id)
				.limit(1);
			
			if (!userIdError && userIdData && userIdData.length > 0) {
				data = userIdData;
				error = null;
			} else {
				// Fallback: get most recent record if no user_id match
				const { data: recentData, error: recentError } = await supabaseClient
					.from('drivers')
					.select('*')
					.order('created_at', { ascending: false })
					.limit(1);
				data = recentData;
				error = recentError;
			}

			if (error) {
				console.error('Failed to load drivers:', error);
				return;
			}

			if (!data || data.length === 0) {
				console.warn('No drivers rows returned.');
				setText('profileName', 'No profile found');
				setText('profileEmail', '-');
				setText('infoFullName', '-');
				setText('infoPhone', '-');
				setText('infoEmail', '-');
				setText('infoUsername', '-');
				setText('infoVehicle', '-');
				setText('infoPlate', '-');
				setText('infoLicense', '-');
				setText('sidebarName', 'Driver');
				setText('sidebarAvatar', 'DR');
				return;
			}

			const row = data[0];
			currentDriverData = row; // Store for edit functionality
			console.log('Loaded driver data:', row);
			console.log('Available columns:', Object.keys(row));
			const fullName = [row.first_name, row.last_name].filter(Boolean).join(' ');
			const emailValue = row.email || row.username || row.email_address || user.email || '-';

			setText('profileName', fullName, 'Driver');
			setText('profileEmail', emailValue);
			setText('infoFullName', fullName, 'Driver');
			setText('infoPhone', row.mobile);
			setText('infoEmail', emailValue);
			setText('infoUsername', row.username || '-');
			setText('infoVehicle', row.vehicle_type);
			setText('infoPlate', row.vehicle_plate || row.plate_number);
			setText('infoLicense', row.license_id);
			setText('sidebarName', fullName, 'Driver');
			setText('sidebarAvatar', getInitials(fullName), 'DR');
			setVerificationStatus(row.status);

			if (row.profile_pic_path) {
				console.log('Profile pic path found:', row.profile_pic_path);
				
				// Try to get a signed URL (works even if bucket is not public)
				const { data: signedData, error: signedError } = await supabaseClient.storage
					.from('driver_info')
					.createSignedUrl(row.profile_pic_path, 3600); // 1 hour expiry

				let imageUrl = null;

				if (signedData && signedData.signedUrl) {
					console.log('Using signed URL:', signedData.signedUrl);
					imageUrl = signedData.signedUrl;
				} else {
					// Fallback to public URL
					console.log('Signed URL failed, trying public URL. Error:', signedError);
					const publicUrl = supabaseClient.storage
						.from('driver_info')
						.getPublicUrl(row.profile_pic_path);
					
					if (publicUrl?.data?.publicUrl) {
						console.log('Using public URL:', publicUrl.data.publicUrl);
						imageUrl = publicUrl.data.publicUrl;
					}
				}

				if (imageUrl) {
					const img = document.getElementById('profileImage');
					const fallback = document.getElementById('profileFallback');
					
					// Add error handler for image loading
					img.onerror = function() {
						console.error('Failed to load image from:', imageUrl);
						console.error('Please check:');
						console.error('1. Storage bucket exists and is named "driver_info"');
						console.error('2. Bucket has public access OR RLS policies allow read access');
						console.error('3. File exists at path:', row.profile_pic_path);
						img.style.display = 'none';
						if (fallback) {
							fallback.style.display = 'flex';
						}
					};
					
					// Add success handler
					img.onload = function() {
						console.log('Image loaded successfully');
						img.style.display = 'block';
						if (fallback) {
							fallback.style.display = 'none';
						}
					};
					
					img.src = imageUrl;
				} else {
					console.error('No valid URL generated');
				}
			} else {
				console.log('No profile_pic_path in database');
			}

			// Load stats data from database
			await loadStatsData(user.id);
		}

		async function loadStatsData(userId) {
			try {
				// Get today's date range
				const today = new Date();
				today.setHours(0, 0, 0, 0);
				const todayEnd = new Date();
				todayEnd.setHours(23, 59, 59, 999);

				// Fetch today's rides/earnings (customize based on your rides table)
				const { data: todayRides, error: ridesError } = await supabaseClient
					.from('rides')
					.select('*')
					.eq('driver_id', userId)
					.gte('created_at', today.toISOString())
					.lte('created_at', todayEnd.toISOString());

				if (!ridesError && todayRides) {
					const totalEarnings = todayRides.reduce((sum, ride) => sum + (ride.fare || 0), 0);
					document.getElementById('earningsAmount').textContent = `‚Ç±${totalEarnings.toFixed(2)}`;
					const bookingsCount = todayRides.length;
					document.getElementById('bookingsCount').textContent = bookingsCount;
					document.getElementById('bookingsStatus').textContent = bookingsCount > 0 ? 'All confirmed' : 'No bookings';
				}

				// Fetch weekly average (last 7 days)
				const weekAgo = new Date(today);
				weekAgo.setDate(weekAgo.getDate() - 7);

				const { data: weekRides, error: weekError } = await supabaseClient
					.from('rides')
					.select('*')
					.eq('driver_id', userId)
					.gte('created_at', weekAgo.toISOString());

				if (!weekError && weekRides) {
					const weeklyTotal = weekRides.reduce((sum, ride) => sum + (ride.fare || 0), 0);
					const weeklyAverage = (weeklyTotal / 7).toFixed(2);
					document.getElementById('weeklyAverage').textContent = `‚Ç±${weeklyAverage}`;
				}

				// Update route information (customize based on your bookings table)
				const { data: currentRide } = await supabaseClient
					.from('rides')
					.select('*')
					.eq('driver_id', userId)
					.eq('status', 'en_route')
					.limit(1);

				if (currentRide && currentRide.length > 0) {
					const ride = currentRide[0];
					document.getElementById('routeDescription').textContent = `${ride.pickup_location || 'Pickup'} ‚Üí ${ride.dropoff_location || 'Dropoff'}`;
					const distance = ride.distance || 0;
					document.getElementById('distanceStat').textContent = `${distance} km`;
				}

				console.log('Stats loaded successfully');
			} catch (error) {
				console.error('Error loading stats:', error);
			}
		}
		async function checkAuth() {
			const { data: { user } } = await supabaseClient.auth.getUser();
			
			if (!user) {
				alert('Please log in first');
				window.location.href = 'login.html';
				return;
			}
			
			// Display user information in sidebar
			const userEmail = user.email || 'User';
			const userName = user.user_metadata?.full_name || userEmail.split('@')[0];
			const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
			
			document.getElementById('sidebarName').textContent = userName;
			document.getElementById('sidebarAvatar').textContent = userInitials || 'U';
			
			// Load profile data from database
			await loadProfile();
		}

		// Logout function
		async function logout() {
			await supabaseClient.auth.signOut();
			window.location.href = 'login.html';
		}

		// Initialize on page load
		window.addEventListener('DOMContentLoaded', checkAuth);
	</script>
</body>
</html>
