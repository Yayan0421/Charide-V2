<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charide ‚Äì Driver Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
/* GENERAL */
body, html{
  margin:0; padding:0; font-family:'Inter', sans-serif;
  height:100%;
}

.app{
  display:flex;
  height:100vh;
  background:#f4f4f4;
  margin-left:280px;
}

.sidebar-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  z-index:9;
  opacity:0;
  visibility:hidden;
  transition:opacity 0.3s ease, visibility 0.3s ease;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  left:0;
  height:100vh;
  width:280px;
  background:linear-gradient(180deg, #0aa812 0%, #078c0f 100%);
  color:#fff;
  display:flex;
  flex-direction:column;
  padding:0;
  box-shadow:4px 0 12px rgba(10, 168, 18, 0.2);
  overflow-y:auto;
  transition:transform 0.3s ease, width 0.3s ease;
  will-change:transform, width;
  z-index:10;
}

.sidebar-header{
  padding:30px 20px;
  display:flex;
  align-items:center;
  gap:12px;
  border-bottom:2px solid rgba(255, 255, 255, 0.1);
}

.sidebar-logo{
  width:48px;
  height:48px;
  object-fit:contain;
  border-radius:50%;
  background:white;
  padding:4px;
}

.sidebar-title{
  font-size:24px;
  font-weight:700;
  color:#ffffff;
  white-space:nowrap;
}

.sidebar-toggle{
  margin-left:auto;
  background:rgba(255, 255, 255, 0.18);
  border:none;
  color:#fff;
  width:36px;
  height:36px;
  border-radius:10px;
  cursor:pointer;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:transform 0.3s ease, background 0.3s ease;
}

.sidebar-links{
  flex:1;
  padding:20px 0;
  display:flex;
  flex-direction:column;
}

.sidebar-links a{
  display:flex;
  align-items:center;
  gap:12px;
  padding:15px 20px;
  color:rgba(255, 255, 255, 0.9);
  text-decoration:none;
  transition:all 0.3s ease;
  cursor:pointer;
  font-size:15px;
  font-weight:500;
  border-left:4px solid transparent;
}

.sidebar-links a .link-text{
  flex:1;
}

.sidebar-links a:hover,
.sidebar-links a.active{
  background:rgba(255, 255, 255, 0.1);
  color:#ffffff;
  border-left-color:#ffc107;
}

.sidebar-profile{
  display:flex;
  align-items:center;
  gap:10px;
  padding:20px;
  border-bottom:2px solid rgba(255, 255, 255, 0.1);
}

.avatar{
  width:50px;
  height:50px;
  background:rgba(255, 255, 255, 0.2);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#fff;
  flex-shrink:0;
}

.profile-info{
  display:flex;
  flex-direction:column;
}

.profile-info strong{
  font-size:14px;
  color:#ffffff;
  margin:0;
  font-weight:600;
}

.profile-info small{
  font-size:12px;
  color:rgba(255, 255, 255, 0.8);
  margin:2px 0 0 0;
}

/* LOGOUT BUTTON */
.sidebar-logout{
  display:flex;
  align-items:center;
  gap:12px;
  padding:15px 20px;
  color:rgba(255, 255, 255, 0.9);
  text-decoration:none;
  transition:all 0.3s ease;
  cursor:pointer;
  font-size:15px;
  font-weight:500;
  border-left:4px solid transparent;
  border-top:2px solid rgba(255, 255, 255, 0.1);
  margin-top:auto;
}

.sidebar-logout:hover{
  background:rgba(255, 255, 255, 0.1);
  color:#ffffff;
  border-left-color:#ff6b6b;
}

.sidebar-logout button{
  display:none;
}

/* MAIN CONTENT */
.content{
  flex:1;
  padding:25px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
}


h1{
  margin-top:0;
  color:#2e7d32;
}

.dashboard-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:25px;
}

.dashboard-header > div{
  flex:1;
}

.subtitle{
  color:#4caf50;
  margin-bottom:0;
}

.availability-btn{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  background:#43a047;
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
  font-size:14px;
  white-space:nowrap;
}

.availability-btn:hover{
  background:#66bb6a;
}

.availability-btn.unavailable{
  background:#ef4444;
}

.availability-btn.unavailable:hover{
  background:#dc2626;
}

/* STATS CARDS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin-bottom:25px;
}

.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

.card-header{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
  margin-bottom:8px;
}

.badge{
  background:#43a047;
  color:#fff;
  font-size:10px;
  padding:2px 6px;
  border-radius:4px;
}

/* MAIN CARDS */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
}

.main .card{
  flex:1;
  margin-bottom:20px;
  display:flex;
  flex-direction:column;
}

.route-item{
  margin-bottom:10px;
}

.route-stats{
  display:flex;
  gap:10px;
  margin:10px 0;
}

.route-box{
  flex:1;
  background:#e8f5e9;
  padding:10px;
  border-radius:8px;
  text-align:center;
}

#map{
  flex:1;
  width:100%;
  border-radius:8px;
  min-height:0;
  position:relative;
}

.map-debug{
  position:absolute;
  bottom:12px;
  left:12px;
  background:rgba(17, 24, 39, 0.9);
  color:#f9fafb;
  padding:8px 10px;
  border-radius:8px;
  font-size:12px;
  line-height:1.4;
  z-index:500;
  pointer-events:none;
}

.rider-pin-wrapper{
  width:36px;
  height:36px;
}

.rider-pin{
  width:36px;
  height:36px;
  background:#1a8f3a;
  border-radius:50% 50% 50% 0;
  transform:rotate(-45deg);
  box-shadow:0 6px 12px rgba(0,0,0,0.2);
  position:relative;
}

.rider-pin__avatar{
  position:absolute;
  top:6px;
  left:6px;
  width:24px;
  height:24px;
  background:#ffffff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:700;
  color:#14532d;
  transform:rotate(45deg);
  border:2px solid #ffffff;
  overflow:hidden;
}

.rider-pin__avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.booking{
  background:#e8f5e9;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
}

.booking-header{
  display:flex;
  justify-content:space-between;
  font-weight:bold;
}

.call-btn{
  margin-top:5px;
  padding:6px 12px;
  border:none;
  border-radius:5px;
  background:#43a047;
  color:white;
  cursor:pointer;
}

.call-btn:hover{
  background:#66bb6a;
}

#startNavBtn{
  width:100%;
  padding:10px;
  border:none;
  border-radius:5px;
  background:#43a047;
  color:white;
  cursor:pointer;
  margin-top:10px;
}

#startNavBtn:hover{
  background:#66bb6a;
}

.app.is-collapsed .sidebar{
  width:90px;
}

.app.is-collapsed .sidebar-title,
.app.is-collapsed .profile-info,
.app.is-collapsed .sidebar-links a .link-text{
  display:none;
}

.app.is-collapsed .sidebar-header{
  justify-content:center;
}

@media (max-width: 1024px){
  .app.is-collapsed .sidebar{
    width:80px;
  }
}

@media (max-width: 820px){
  .sidebar{
    position:fixed;
    top:0;
    bottom:0;
    left:0;
    transform:translateX(-100%);
  }

  .app.sidebar-open .sidebar{
    transform:translateX(0);
  }

  .app.sidebar-open + .sidebar-overlay{
    opacity:1;
    visibility:visible;
  }

  .content{
    padding:18px;
  }
}

.app.is-collapsed .sidebar-toggle{
  transform:rotate(180deg);
}
</style>
</head>
<body>

<div class="app" id="appShell">

  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="logo.png" alt="Charide" class="sidebar-logo">
      <span class="sidebar-title">Charide</span>
      <button class="sidebar-toggle" id="sidebarCollapse" aria-label="Collapse sidebar">‚Äπ</button>
    </div>

    <nav class="sidebar-links">
      <a class="active" href="dashboard-driver.html">üè† <span class="link-text">Dashboard</span></a>
      <a href="message-1.html">üí¨ <span class="link-text">Messages</span></a>
      <a href="booking.html">üìÖ <span class="link-text">Bookings</span></a>
      <a href="support-devices.html">üÜò <span class="link-text">Support</span></a>
      <a href="about-us-1.html">‚ÑπÔ∏è <span class="link-text">About Us</span></a>
      <a href="profile.html">üë§ <span class="link-text">Profile</span></a>
    </nav>

    <div class="sidebar-profile">
      <div class="avatar" id="userAvatar">JD</div>
      <div class="profile-info">
        <strong id="userName">John Driver</strong>
        <small>Driver</small>
      </div>
    </div>

    <a href="#" class="sidebar-logout" onclick="logout(); return false;">
      üö™ Log Out
    </a>
  </aside>

  <main class="content">
    <div class="dashboard-header">
      <div>
        <h1>Driver Dashboard</h1>
        <p class="subtitle" id="welcomeMsg">Welcome back! Here's your daily overview.</p>
      </div>
      <button class="availability-btn" id="availabilityBtn" onclick="toggleAvailability()">üü¢ Available</button>
    </div>

    <div class="main">
      <div class="card">
        <h3>Live Map</h3>
        <div id="map">
          <div class="map-debug" id="mapDebug">Waiting for GPS‚Ä¶</div>
        </div>
      </div>
    </div>
  </main>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
const API_BASE_URL = window.API_BASE_URL || window.location.origin;
const AUTH_TOKEN_KEY = 'charide_token';
const REFRESH_TOKEN_KEY = 'charide_refresh_token';
const USER_KEY = 'charide_user';

const { createClient } = supabase;
const supabaseUrl = 'https://cvfjpigbkbzjvvfzvjzr.supabase.co';
const supabaseKey = 'sb_publishable_Wt2fAK6-5mkAX4SNyobCYQ_YPROnFM4';
const client = createClient(supabaseUrl, supabaseKey);

async function apiRequest(path, options = {}) {
  const url = API_BASE_URL.replace(/\/+$/, '') + path;
  const headers = Object.assign({
    'Content-Type': 'application/json'
  }, options.headers || {});

  const token = localStorage.getItem(AUTH_TOKEN_KEY);
  if (token) headers.Authorization = 'Bearer ' + token;

  const response = await fetch(url, {
    method: options.method || 'GET',
    headers,
    body: options.body ? JSON.stringify(options.body) : undefined
  });

  const text = await response.text();
  const data = text ? JSON.parse(text) : null;

  if (!response.ok) {
    const message = (data && (data.error || data.message)) || 'Request failed (' + response.status + ')';
    throw new Error(message);
  }

  return data;
}

async function bootstrapSupabaseSession() {
  const accessToken = localStorage.getItem(AUTH_TOKEN_KEY);
  const refreshToken = localStorage.getItem(REFRESH_TOKEN_KEY);
  if (!accessToken || !refreshToken) return false;

  const { error } = await client.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken
  });

  if (error) {
    console.warn('Supabase session bootstrap failed:', error.message || error);
    return false;
  }
  return true;
}

// Check authentication on page load
async function checkAuth() {
  let user = null;
  try {
    const data = await apiRequest('/auth/me');
    user = data && data.user ? data.user : null;
  } catch (err) {
    user = null;
  }

  if (!user || user.user_type !== 'driver') {
    alert('Please log in first');
    localStorage.removeItem(AUTH_TOKEN_KEY);
    localStorage.removeItem(REFRESH_TOKEN_KEY);
    localStorage.removeItem(USER_KEY);
    window.location.href = 'login.html';
    return;
  }

  localStorage.setItem(USER_KEY, JSON.stringify(user));
  await bootstrapSupabaseSession();

  // Display user information
  const userEmail = user.email || 'User';
  const userName = user.full_name || userEmail.split('@')[0];
  const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
  
  document.getElementById('userName').textContent = userName;
  document.getElementById('userAvatar').textContent = userInitials || 'U';
  document.getElementById('welcomeMsg').textContent = `Welcome back, ${userName}! Here's your daily overview.`;

  initMap(user);
}

// Toggle availability function (updates backend)
async function toggleAvailability() {
  const btn = document.getElementById('availabilityBtn');
  const currentlyUnavailable = btn.classList.contains('unavailable');
  const willBeAvailable = !currentlyUnavailable;

  // optimistic UI change
  btn.disabled = true;
  try {
    let lat = null, lng = null;
    if (navigator.geolocation) {
      const pos = await new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(p => resolve(p), () => resolve(null), { enableHighAccuracy: true, maximumAge: 5000 });
      });
      if (pos) {
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
      }
    }

    await apiRequest('/driver/status', {
      method: 'PUT',
      body: { is_online: willBeAvailable, lat, lng }
    });

    // update UI
    btn.classList.toggle('unavailable', !willBeAvailable);
    if (willBeAvailable) {
      btn.textContent = 'üü¢ Available';
    } else {
      btn.textContent = 'üî¥ Unavailable';
    }
  } catch (err) {
    console.error('Failed to update availability:', err);
    alert('Unable to change availability: ' + (err.message || err));
  } finally {
    btn.disabled = false;
  }
}

// Logout function
async function logout() {
  localStorage.removeItem(AUTH_TOKEN_KEY);
  localStorage.removeItem(REFRESH_TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
  await client.auth.signOut();
  window.location.href = 'login.html';
}

// Initialize on page load
checkAuth();

const appShell = document.getElementById('appShell');
const sidebarCollapse = document.getElementById('sidebarCollapse');
const sidebarOverlay = document.getElementById('sidebarOverlay');

function closeSidebar() {
  appShell.classList.remove('sidebar-open');
}

sidebarCollapse.addEventListener('click', () => {
  appShell.classList.toggle('is-collapsed');
});

sidebarOverlay.addEventListener('click', closeSidebar);

document.querySelectorAll('.sidebar-links a').forEach(link => {
  link.addEventListener('click', () => {
    if (window.innerWidth <= 820) {
      closeSidebar();
    }
  });
});

let map;
let driverMarker;
let hasCenteredOnDriver = false;
const riderMarkers = new Map();

function buildInitials(name) {
  if (!name) return "R";
  return name
    .split(" ")
    .filter(Boolean)
    .slice(0, 2)
    .map(part => part[0].toUpperCase())
    .join("");
}

function buildRiderIcon(name) {
  const initials = buildInitials(name);
  return L.divIcon({
    className: "rider-pin-wrapper",
    html: `<div class="rider-pin"><div class="rider-pin__avatar"><span>${initials}</span></div></div>`,
    iconSize: [36, 36],
    iconAnchor: [18, 34],
    popupAnchor: [0, -32]
  });
}

function upsertRiderMarker(ride) {
  if (ride.pickup_lat == null || ride.pickup_lng == null) return;
  const coords = [ride.pickup_lat, ride.pickup_lng];
  const marker = riderMarkers.get(ride.id);
  if (marker) {
    marker.setLatLng(coords);
    marker.setIcon(buildRiderIcon(ride.passenger_name));
    return;
  }

  const newMarker = L.marker(coords, {
    icon: buildRiderIcon(ride.passenger_name)
  }).addTo(map);

  const label = ride.passenger_name ? `Passenger: ${ride.passenger_name}` : "Passenger pickup";
  newMarker.bindPopup(label);
  riderMarkers.set(ride.id, newMarker);
}

function removeRiderMarker(rideId) {
  const marker = riderMarkers.get(rideId);
  if (!marker) return;
  marker.remove();
  riderMarkers.delete(rideId);
}

async function loadActiveRides(userId) {
  const { data, error } = await client
    .from("rides_driver")
    .select("id, passenger_name, pickup_lat, pickup_lng, status")
    .eq("driver_id", userId)
    .eq("status", "in_progress");

  if (error) {
    console.error("Failed to load rides_driver:", error);
    return;
  }

  const activeIds = new Set();
  data.forEach(ride => {
    if (ride.pickup_lat == null || ride.pickup_lng == null) return;
    activeIds.add(ride.id);
    upsertRiderMarker(ride);
  });

  Array.from(riderMarkers.keys()).forEach(id => {
    if (!activeIds.has(id)) {
      removeRiderMarker(id);
    }
  });
}

function subscribeToRides(userId) {
  client
    .channel("rides_driver_map")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "rides_driver", filter: `driver_id=eq.${userId}` },
      payload => {
        const row = payload.new || payload.old;
        if (!row) return;
        if (payload.eventType === "DELETE" || row.status !== "in_progress") {
          removeRiderMarker(row.id);
          return;
        }
        upsertRiderMarker(row);
      }
    )
    .subscribe();
}

function startDriverTracking() {
  if (!navigator.geolocation) return;
  const debugEl = document.getElementById("mapDebug");
  navigator.geolocation.watchPosition(
    pos => {
      const current = [pos.coords.latitude, pos.coords.longitude];
      if (debugEl) {
        const accuracy = Math.round(pos.coords.accuracy || 0);
        debugEl.textContent = `Lat: ${current[0].toFixed(6)}  Lng: ${current[1].toFixed(6)}  Accuracy: ${accuracy}m`;
      }
      if (!driverMarker) {
        driverMarker = L.circleMarker(current, {
          radius: 7,
          color: "#0a8f08",
          fillColor: "#22c55e",
          fillOpacity: 0.9
        }).addTo(map);
      } else {
        driverMarker.setLatLng(current);
      }

      if (!hasCenteredOnDriver) {
        map.setView(current, 15);
        hasCenteredOnDriver = true;
      } else {
        map.panTo(current, { animate: true, duration: 0.35 });
      }
    },
    () => {
      if (debugEl) {
        debugEl.textContent = "GPS not available";
      }
      console.warn("GPS not available");
    },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );
}

function initMap(user) {
  if (map) return;
  map = L.map("map").setView([11.6084, 125.4317], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors"
  }).addTo(map);

  startDriverTracking();
  loadActiveRides(user.id);
  subscribeToRides(user.id);
}
</script>

</body>
</html>

